---
import { findImage, parseImageSize } from '~/utils/images';
import {
  getImagesOptimized,
  astroAssetsOptimizer,
  unpicOptimizer,
  type ImageProps,
  type AttributesProps,
} from '~/utils/images-optimization';

type Props = ImageProps;
type ImageType = {
  src: string;
  attributes: AttributesProps;
};

const props: Props = Astro.props;

if (props.alt == null) {
  throw new Error(
    'Image component requires an "alt" attribute for accessibility.',
  );
}

props.width = parseImageSize(props.width);
props.height = parseImageSize(props.height);

if (!props.loading) {
  props.loading = 'lazy';
}

if (!props.decoding) {
  props.decoding = 'async';
}

const _image = await findImage(props.src);

let image: ImageType | undefined = undefined;

if (_image !== null && typeof _image === 'object') {
  image = await getImagesOptimized(_image, props, astroAssetsOptimizer);
} else if (
  typeof _image === 'string' &&
  (_image.startsWith('http://') || _image.startsWith('https://'))
) {
  image = await getImagesOptimized(_image, props, unpicOptimizer);
} else if (_image) {
  image = await getImagesOptimized(_image, props);
}
---

{!image ? <Fragment /> : <img src={image.src} {...image.attributes} />}
